<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <main class="app-shell">
        <section class="panel">
            <div class="dashboard-header">
                <div>
                    <h1 class="brand" style="margin: 0;">Security Analytics
                        <small>Live Auth Telemetry</small>
                    </h1>
                </div>
                <div class="btn-row">
                    <a href="/" class="btn btn-dark">Home</a>
                    <a href="/login" class="btn btn-dark">Re-authenticate</a>
                </div>
            </div>

            {% set total_users = login_labels|length %}
            {% set total_otps = otp_counts|sum %}
            {% set total_locks = locked_count %}

            <div class="kpi-grid">
                <div class="kpi">
                    <small>Tracked Users</small>
                    <strong>{{ total_users }}</strong>
                </div>
                <div class="kpi">
                    <small>OTPs Issued</small>
                    <strong>{{ total_otps }}</strong>
                </div>
                <div class="kpi">
                    <small>Locked Accounts</small>
                    <strong>{{ total_locks }}</strong>
                </div>
            </div>

            <div class="chart-grid">
                <article class="chart-card">
                    <h3>Login Attempt Distribution</h3>
                    <canvas id="loginAttemptsChart"></canvas>
                </article>

                <article class="chart-card">
                    <h3>Account Lock Status</h3>
                    <canvas id="accountLocksChart"></canvas>
                </article>

                <article class="chart-card" style="grid-column: 1 / -1;">
                    <h3>OTP Activity by Account</h3>
                    <canvas id="otpStatusChart"></canvas>
                </article>
            </div>
        </section>
    </main>

    <script>
        const loginLabels = {{ login_labels|tojson|safe }};
        const loginCounts = {{ login_counts|tojson|safe }};
        const otpLabels = {{ otp_labels|tojson|safe }};
        const otpCounts = {{ otp_counts|tojson|safe }};

        const chartDefaults = {
            plugins: {
                legend: {
                    labels: {
                        color: '#d6e2ff',
                        font: { family: 'Sora' }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#c2d2ff' },
                    grid: { color: 'rgba(168,188,255,0.14)' }
                },
                y: {
                    ticks: { color: '#c2d2ff' },
                    grid: { color: 'rgba(168,188,255,0.14)' },
                    beginAtZero: true
                }
            }
        };

        new Chart(document.getElementById('loginAttemptsChart'), {
            type: 'bar',
            data: {
                labels: loginLabels,
                datasets: [{
                    label: 'Attempts',
                    data: loginCounts,
                    borderRadius: 9,
                    backgroundColor: 'rgba(110, 231, 255, 0.55)',
                    borderColor: 'rgba(110, 231, 255, 0.95)',
                    borderWidth: 1.2
                }]
            },
            options: chartDefaults
        });

        new Chart(document.getElementById('accountLocksChart'), {
            type: 'doughnut',
            data: {
                labels: ['Locked', 'Unlocked'],
                datasets: [{
                    data: [{{ locked_count }}, {{ unlocked_count }}],
                    backgroundColor: ['rgba(255, 111, 145, 0.75)', 'rgba(68, 228, 169, 0.72)'],
                    borderColor: ['rgba(255, 111, 145, 1)', 'rgba(68, 228, 169, 1)'],
                    borderWidth: 1.1
                }]
            },
            options: {
                plugins: {
                    legend: {
                        labels: {
                            color: '#d6e2ff',
                            font: { family: 'Sora' }
                        }
                    }
                }
            }
        });

        new Chart(document.getElementById('otpStatusChart'), {
            type: 'line',
            data: {
                labels: otpLabels,
                datasets: [{
                    label: 'OTPs Sent',
                    data: otpCounts,
                    fill: true,
                    tension: 0.32,
                    borderColor: 'rgba(124, 131, 255, 1)',
                    backgroundColor: 'rgba(124, 131, 255, 0.24)',
                    pointBackgroundColor: 'rgba(110, 231, 255, 1)',
                    pointRadius: 4
                }]
            },
            options: chartDefaults
        });
    </script>
</body>
</html>
